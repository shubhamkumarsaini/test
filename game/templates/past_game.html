{% extends 'home.html' %}

{% block custom_css %}
<style>
    /* General Styles */
    .TvSection {
        padding: 2px;
        background-color: #f8f9fa;
    }

    .TvFram {
        background: #ffffff;
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        overflow: hidden;
    }

    .TvFramHeader {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 20px;
        background-color: #343a40;
        color: #ffffff;
    }

    .TvFramHeader .logo img {
        height: 40px;
    }

    .TvFramMenu span {
        margin: 0 5px;
        font-size: 18px;
        cursor: pointer;
        color: #ffffff;
    }
    
    .TvFramMenu span:hover {
        color: #ffc107;
    }
    

    .TvImg {
        position: relative;
    }

    .TvImg img {
        width: 100%;
        height: 280px;
    }
    .TvFramFooter {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 20px;
        background-color: #343a40;
        color: #ffffff;
    }
    
    .TvSearchFrom {
        padding: 15px 20px;
        border-top: 1px solid #dee2e6;
    }

    .TvSearchFrom .form-control {
        border-radius: 0;
        box-shadow: none;
    }

    .TvSearchFrom .btn {
        border-radius: 0;
    }
    #imageButtons .btn {
        width: 40px;
        height: 40px;
        padding: 0;
        border-radius: 50%;  /* Makes the button round */
        font-size: 16px;
        justify-content: center;
        align-items: center;
        text-align: center;
    }
    
    #imageButtons .btn-outline-secondary {
        border: 2px solid #6c757d;
        color: #6c757d;
    }
    
    #imageButtons .btn-outline-secondary:hover {
        background-color: #6c757d;
        color: #fff;
    }
    #answerIndicators {
        display: flex;
        gap: 4px; /* Adjust for small screens */
        justify-content: center; /* Center the circles horizontally */
    }
    
    #answerIndicators > div {
        width: 23px; /* Default size (small) */
        height: 23px;
        background-color: #c9c0c0; /* Tailwind's 'red-700' */
        border-radius: 9999px; /* Full rounding for a circle */
        border: 2px solid black; /* Black border around each circle */
    }
    
    @media (min-width: 640px) {
        #answerIndicators {
            gap: 8px; /* Increased spacing on larger screens */
        }
        #answerIndicators > div {
            width: 23px; /* Larger size for medium screens */
            height: 23px;
        }
    }
</style>
{% endblock %}

{% block content %}
<section class="TvSection">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-6">
                <div class="addBanner mb-3">
                    <img class="w-100" src="/static/image/addBanner.jpg" alt="Advertisement">
                </div>

                <div class="TvFram">
                    <div class="TvFramHeader">
                        <div class="navigation">
                            <!-- Previous Game Link -->
                            {% if previous_id %}
                            <a href="{% url 'past_game' previous_id %}" class="btn btn-outline-light btn-sm d-flex align-items-center">
                                <i class="fa-solid fa-arrow-left me-2"></i> Previous ({{ previous_id }})
                            </a>
                            {% else %}
                            <span class="btn btn-outline-secondary btn-sm d-flex align-items-center disabled">
                                <i class="fa-solid fa-arrow-left me-2"></i> Previous
                            </span>
                            {% endif %}
                        </div>
                    
                        <div class="game-details">
                            <a href="{% url 'calendar' %}">
                            <h4 class="text-xl italic font-semibold text-center mb-0 text-white">#{{ game.id }} - {{ game.date }}</h4>
                            </a>
                        </div>
                    
                        <div class="navigation">
                            <!-- Next Game Link -->
                            {% if next_id %}
                            <a href="{% url 'past_game' next_id %}" class="btn btn-outline-light btn-sm d-flex align-items-center">
                                Next ({{ next_id }}) <i class="fa-solid fa-arrow-right ms-2"></i>
                            </a>
                            {% else %}
                            <span class="btn btn-outline-secondary btn-sm d-flex align-items-center disabled">
                                No Past Game <i class="fa-solid fa-arrow-right ms-2"></i>
                            </span>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="TvImg">
                        {% for image in images %}
                            <div class="image-container {% if forloop.counter != 1 %}d-none{% endif %}" id="image-{{ forloop.counter }}">
                                <img src="{{ image.image.url }}" class="img-fluid rounded" alt="Episode Image {{ forloop.counter }}" >
                            </div>
                        {% endfor %}
                        
                    </div>
                    <div class="TvFramFooter">
                        <div class="TvFramMenu">
                            <div id="imageButtons">
                                <button class="btn btn-outline-secondary d-none rounded-circle" id="button-1" onclick="showImage(1)">1</button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="TvSearchFrom">
                        <form id="guessForm" class="mt-2" action="{% url 'submit_guess' game.id %}" method="post">
                            {% csrf_token %}
                            <div class="input-group">
                                <input type="text" id="guess" name="guess" class="form-control" placeholder="Enter the TV show name">
                                <button type="submit" class="btn btn-dark">Submit</button>
                            </div>
                            <div class="guesses">
                                <p class="mt-2">6 GUESSES REMAINING</p>
                            </div> 
                        </form>
                        
                        <div id="feedback" class="mt-3 alert text-center"></div>

                        <div id="todayresult" class="mt-3 alert d-none text-center">
                            <p class="text-sm">THE ANSWER WAS: <span id="answerText">{{ message }}</span></p>
                            <div class="flex gap-1 sm:gap-2 justify-center" id="answerIndicators">
                                <!-- Dynamic indicators -->
                            </div>
                            <div class="d-flex gap-2 mt-3">
                                <button class="btn btn-secondary" onclick="toggleFeedbackClass()">Show Guesses</button>
                                <button class="btn btn-primary" onclick="copyResult()">Share result</button>
                            </div>
                            <div id="feedbackhistory" class="text-slate-800 bg-light p-2 d-none">
                                <!-- Feedback content -->
                            </div>
                            <div class="d-flex justify-content-between align-items-center mt-3">
                                <div>Next Movie: <span id="nextMovieTimer">05:50:11</span></div>
                                <a href="#" class="btn btn-danger">More Games</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
{% endblock %}



{% block custom_js %}
<script>
    let currentImageIndex = 1;
    const maxAttempts = 6;
    let remainingGuesses = maxAttempts;
    const feedback = document.getElementById('feedback');
    const guessesElement = document.querySelector('.guesses p');
    const answerText = document.getElementById('answerText');
    const answerIndicators = document.getElementById('answerIndicators');
    const nextMovieTimer = document.getElementById('nextMovieTimer');
    // Get today's date in YYYY-MM-DD format
    function getCookie(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return parts.pop().split(';').shift();
    }

    // Function to set cookies
    function setCookie(name, value, days) {
        const date = new Date();
        date.setTime(date.getTime() + days * 24 * 60 * 60 * 1000);
        const expires = `expires=${date.toUTCString()}`;
        document.cookie = `${name}=${value};${expires};path=/`;
    }
    function deleteCookies() {
        // Delete the guess_historypast cookie
        deleteCookie('guess_historypast');
        
    }

    // Function to delete a cookie
    function deleteCookie(name) {
        document.cookie = `${name}=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;`;
    }

    // Function to parse JSON cookie and filter by today's date
    function parseJSONCookie(name) {
        const cookieValue = getCookie(name);
        if (!cookieValue) return [];

        const data = JSON.parse(cookieValue);
        return data; // Return all data since we're not filtering by date anymore
    }

    // Function to add a new guess with today's date
    function addGuessToCookie(guessText, result, message, current_attempt, remaining_attempts, image_to_show) {
        const guesses = parseJSONCookie('guess_historypast') || [];

        // Add the new guess
        guesses.push({ text: guessText, result: result, message: message, current_attempt: current_attempt, remaining_attempts: remaining_attempts, image_to_show: image_to_show });

        // Save updated guesses to cookie
        setCookie('guess_historypast', JSON.stringify(guesses), 1); // Save for 1 day
    }


    // Update feedback to show today's guesses
    function updateFeedback(guesses) {
        const feedback = document.getElementById('feedback'); // Feedback container
        
        // Clear previous feedback
        feedback.innerHTML = '';
        
        // Create a flex container to hold all the guess items
        const feedbackContainer = document.createElement('div');
        feedbackContainer.classList.add('flex', 'flex-col', 'text-center');
        
        // Loop through each guess and create a div
        guesses.forEach((guess, index) => {
            const guessDiv = document.createElement('div');
            guessDiv.classList.add('flex', 'items-center', 'justify-center', 'mb-2'); // Align items in one line
            
            // Create a single div to hold both ❌/✅ and guess text
            guessDiv.innerHTML = `${guess.result === 'correct' ? '✅' : '❌'}&nbsp;&nbsp;${index + 1}. ${guess.text}`;
            
            // Append this guess div to the feedback container
            feedbackContainer.appendChild(guessDiv);
        });
    
        // Append the feedback container to the feedback div
        feedback.appendChild(feedbackContainer);
    }

    // Show the specified image by index
    function showImage(index) {
        document.querySelectorAll('.image-container').forEach(image => image.classList.add('d-none'));
        document.getElementById(`image-${index}`).classList.remove('d-none');
        currentImageIndex = index;

        // Save current image index to local storage
        localStorage.setItem('currentImageIndex', currentImageIndex);
    }

    // Update image navigation buttons
    function updateImageButtons(maxVisibleIndex) {
        const imageButtonsContainer = document.getElementById('imageButtons');
        
        Array.from(imageButtonsContainer.children).forEach(button => {
            const buttonIndex = parseInt(button.textContent, 10);
            if (buttonIndex > maxVisibleIndex) {
                button.classList.add('d-none');
            } else {
                button.classList.remove('d-none');
            }
        });

        for (let i = 1; i <= maxVisibleIndex; i++) {
            let button = document.getElementById(`button-${i}`);
            if (!button) {
                button = document.createElement('button');
                button.className = 'btn btn-outline-secondary counter';
                button.id = `button-${i}`;
                button.textContent = i;
                button.onclick = () => showImage(i);
                imageButtonsContainer.appendChild(button);
            }
        }
    }
    
    function toggleFeedbackClass() {
        const feedbackElement = document.getElementById('feedback'); // Element holding the data
        const feedbackHistoryElement = document.getElementById('feedbackhistory'); // Target container
    
        if (feedbackHistoryElement.classList.contains('d-none')) {
            feedbackHistoryElement.classList.remove('d-none'); // Show feedbackhistory
            feedbackHistoryElement.innerHTML = feedbackElement ? feedbackElement.innerHTML : "No feedback available."; // Set content
        } else {
            feedbackHistoryElement.classList.add('d-none'); // Hide feedbackhistory
        }
    }
        
    // Update today's result section
    function updateTodayResult() {
        const guesses = parseJSONCookie('guess_historypast');
        const correctGuessIndex = guesses.findIndex(guess => guess.result === 'correct');
    
        // Generate 6 divs
        const divs = Array.from({ length: 6 }).map((_, index) => {
            if (index < guesses.length) {
                const guess = guesses[index];
                return `
                    <div class="w-3 h-3" style="background-color: ${guess.result === 'correct' ? '#08c10e' : '#c10808'}; 
                        border-radius: 50%; gap: 4px; border: 2px solid black; width: 20px; height: 20px;">
                    </div>`;
            } else {
                // Neutral for unused attempts
                return `
                    <div class="w-3 h-3" style="background-color: #cccccc; 
                        border-radius: 50%; gap: 4px; border: 2px solid black; width: 20px; height: 20px;">
                    </div>`;
            }
        }).join('');
    
        // Set the indicators
        const answerText = document.getElementById('answerText');
        const answerIndicators = document.getElementById('answerIndicators');
    
        if (correctGuessIndex !== -1) {
            answerText.textContent = "You got it!";
        } else {
            const lastGuess = guesses[guesses.length - 1];
            answerText.textContent = lastGuess.message;
        }
    
        answerIndicators.innerHTML = divs;
    
        // Show the todayresult section
    }
    

    function copyResult() {
        const guesses = parseJSONCookie('guess_historypast'); // Assuming parseJSONCookie exists
        const correctGuessIndex = guesses.findIndex(guess => guess.result === 'correct');
    
        // Determine guess indicators
        const indicators = guesses.map(guess => (guess.result === 'correct' ? "🟢" : "🔴")).join(" ");
        const remainingIndicators = Array(6 - guesses.length).fill("⚪").join(" "); // Empty slots
        const allIndicators = `${indicators} ${remainingIndicators}`.trim();
    
        // Build the result text
        const gameId = "{{ game.id }}";
        const resultText = `Shubham #${gameId}\n🎥 ${allIndicators}\n\nhttp://127.0.0.1:8000/`;
    
        // Copy the result to clipboard
        navigator.clipboard.writeText(resultText).then(() => {
            // Change the button text to "Copied" for 5 seconds
            const shareButton = document.querySelector('button[onclick="copyResult()"]');
            if (shareButton) {
                const originalText = shareButton.textContent;
                shareButton.textContent = "Copied";
                shareButton.disabled = true; // Optionally disable the button to prevent repeated clicks
                setTimeout(() => {
                    shareButton.textContent = originalText;
                    shareButton.disabled = false; // Re-enable the button
                }, 2000);
            }
        }).catch(err => {
            console.error("Failed to copy text:", err);
        });
    }
    

    // Countdown timer for the next movie
    function startCountdown() {
        const targetTime = new Date().setHours(24, 0, 0, 0); // Set to midnight
        function updateTimer() {
            const now = new Date().getTime();
            const distance = targetTime - now;

            if (distance < 0) {
                nextMovieTimer.textContent = "00:00:00";
                clearInterval(timerInterval);
                return;
            }

            const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((distance % (1000 * 60)) / 1000);

            nextMovieTimer.textContent = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        const timerInterval = setInterval(updateTimer, 1000);
        updateTimer(); // Run once immediately
    }
    
    // Function to update the remaining guesses
    function updateRemainingGuesses() {
        guessesElement.textContent = `${remainingGuesses} GUESSES REMAINING`;
    }

    // Handle form submission
    document.getElementById('guessForm').addEventListener('submit', function(event) {
        event.preventDefault();
        const guessInput = document.getElementById('guess');
        const guess = guessInput.value;

        fetch("{% url 'submit_guess' game.id %}", {
            method: 'POST',
            headers: { 'X-CSRFToken': '{{ csrf_token }}' },
            body: new URLSearchParams({ 'guess': guess })
        })
        .then(response => response.json())
        .then(data => {
            
            if (data.result === 'correct') {
                updateImageButtons(6);
                document.getElementById('guessForm').classList.add('d-none'); // Hide the form
                document.getElementById('todayresult').classList.remove('d-none');
                document.getElementById('feedback').classList.add('d-none');
            } else {
                if (currentImageIndex < maxAttempts) {
                    currentImageIndex += 1;
                    showImage(currentImageIndex);
                    updateImageButtons(currentImageIndex);
                }
            }
            // Decrease remaining guesses and update the UI
            remainingGuesses -= 1;
            updateRemainingGuesses();

            // Save the current guess to the cookie
            addGuessToCookie(guess, data.result,data.message,data.current_attempt,remainingGuesses,currentImageIndex);
            
            // Update feedback with today's guesses
            const todaysGuesses = parseJSONCookie('guess_historypast');
            updateFeedback(todaysGuesses);
            updateTodayResult();
            
            // Check if there are no guesses left and the game is not won
            if (remainingGuesses <= 0 && data.result !== 'correct') {
                document.getElementById('guessForm').classList.add('d-none'); // Hide the form
                document.getElementById('feedback').classList.add('d-none');
                document.getElementById('todayresult').classList.remove('d-none');
            }
            // Clear the input field after submission
            guessInput.value = '';
        });
    });

    // On page load: load today's guesses and show the correct image and buttons
    document.addEventListener('DOMContentLoaded', () => {
        // Clear all relevant cookies on page load
        deleteCookies();
    
        // Reset the game state
        currentImageIndex = 1;
        
        remainingGuesses = maxAttempts;
        updateRemainingGuesses();
    
        // Reset the image buttons to show the first image
        updateImageButtons(1);
    });

</script>    

{% endblock %}


